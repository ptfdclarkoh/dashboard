<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- UPDATED TITLE -->
  <title>PTFD Dashboard</title>
  <link rel="icon" type="image/x-icon" href="./assets/256.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <!-- Feather Icons -->
  <script src="https://unpkg.com/feather-icons"></script>
  
  <!-- *** NEW: PapaParse and Day.js for News Feed *** -->
  <!-- 2. Load PapaParse to read the CSV data from Google Sheets -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <!-- 3. Load Day.js to easily handle date and time comparisons -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.11/dayjs.min.js"></script>

  <style>
    /* Custom font family */
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Ensure feather icons are sized correctly */
    .feather {
      width: 1em;
      height: 1em;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      fill: none;
    }

    /*
     * *** NEW: Animation classes for the news feed items ***
     * We control the in/out animation using an 'active' class.
     */
    .feed-item {
        opacity: 0;
        /* Start slides 2rem down */
        transform: translateY(2rem); 
        /* Transition opacity and transform */
        transition: opacity 0.8s cubic-bezier(0.25, 0.8, 0.25, 1), transform 0.8s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .feed-item.active {
        opacity: 1;
        /* Move to original position */
        transform: translateY(0);
    }

    /* * This class is added to the slide that is fading out
     * to give it a different exit animation (fade up).
     */
    .feed-item.fading-out {
        opacity: 0;
        /* Move slide 2rem up */
        transform: translateY(-2rem); 
    }

    /*
     * *** UPDATED: Ticker Animation ***
     * 0% uses 100vw to start fully off-screen right (viewport width)
     * 100% uses -100% to move fully off-screen left (element width)
     */
    @keyframes marquee {
      0% { transform: translateX(100vw); }
      100% { transform: translateX(-100%); }
    }
    
    .animate-marquee {
      animation: marquee 20s linear infinite;
    }

    /* Class to hide ticker initially but allow it to take up space when shown */
    .ticker-hidden {
        display: none;
    }
    .ticker-visible {
        display: flex;
    }
  </style>
</head>
<!-- UPDATED: Changed w-screen to w-full to prevent potential overflow -->
<body class="bg-gray-900 text-white flex flex-col h-screen w-full overflow-hidden">

  <!-- Main content area (sidebar + slides) -->
  <div class="flex-grow flex flex-col md:flex-row min-h-0 transition-all duration-500 ease-in-out" id="main-content-area">
    <!-- Toolbar / Sidebar -->
    <aside class="w-full md:w-64 bg-gray-800 text-white flex md:flex-col justify-around md:justify-between items-center p-4 md:p-5 flex-shrink-0 z-20 shadow-lg">
      <div class="flex flex-col items-center text-center">
        <!-- UPDATED: Added id="dashboard-logo" -->
        <img id="dashboard-logo" src="logo.png" alt="Harmony Township Logo" class="w-40 md:w-60 h-auto rounded-lg" onerror="this.style.display='none'">
      </div>

      <!-- Weather Widget -->
      <div id="toolbar-weather-widget" class="text-center">
          <!-- NEW: Weather Icon -->
          <div id="weather-icon-container" class="text-6xl text-blue-300 mx-auto mb-2 h-16 flex items-center justify-center">
              <i data-feather="loader" class="animate-spin"></i>
          </div>
          <p id="weather-temp" class="text-6xl font-black">--°</p>
          <p id="weather-condition" class="text-2xl text-gray-300 mt-2">Loading...</p>
          <p id="weather-location" class="text-xl font-bold mt-2">...</p>
          <p id="weather-high-low" class="text-md text-gray-400">H: --° L: --°</p>
      </div>
      
      <!-- *** NEW: Sidebar Alert Display *** -->
      <!-- This container sits between weather and clock. Hidden by default. -->
      <div id="sidebar-alert-display" class="w-full hidden px-2 my-2 transition-all duration-300">
         <!-- Content injected by JS when active -->
      </div>
      
      <!-- Clock Container -->
      <div id="clock-container" class="w-48 md:w-full h-20 transition-all duration-300 ease-in-out">
          <iframe title="Time and Date Clock" src="https://free.timeanddate.com/clock/ia164w8b/n805/fn2/fs30/fcfff/tct/pct/ftb/pb5/tt0/tw0/tm1/th1/tb4" frameborder="0" class="w-full h-full" allowtransparency="true"></iframe>
      </div>
    </aside>

    <!-- Main Content Slides -->
    <!-- UPDATED: Removed h-full and added min-h-0 to ensure proper flex scaling -->
    <main class="flex-grow relative min-h-0">
      <div class="slides" id="slidesContainer">
        <div class="slide absolute inset-0 w-full h-full opacity-0 transition-opacity duration-1000 ease-in-out"></div>
        <div class="slide absolute inset-0 w-full h-full opacity-0 transition-opacity duration-1000 ease-in-out"></div>
      </div>
    </main>
  </div>


  <!-- IPAWS / NWS Alert Overlay -->
  <div id="ipawsAlertOverlay" class="fixed inset-0 bg-black bg-opacity-95 text-red-500 text-3xl md:text-5xl font-black flex justify-center items-center text-center z-[9999] p-5 leading-tight opacity-0 invisible transition-opacity duration-500">
    <!-- Alert content will be injected here -->
  </div>
  
  <!-- *** REMOVED: Active911 Alert Overlay *** -->

  <!-- *** NEW: Native Ticker Bar *** -->
  <!-- This is now a flex child of the body, not a fixed footer, so it pushes content up -->
  <div id="ticker-bar" class="w-full h-20 bg-red-900 border-t-4 border-red-700 flex-shrink-0 z-50 hidden items-center overflow-hidden shadow-2xl relative">
      <!-- The scrolling text container -->
      <div id="ticker-content" class="whitespace-nowrap text-4xl font-bold text-white uppercase tracking-wider px-4">
          <!-- Content injected via JS -->
      </div>
  </div>

  <audio id="alertSound"></audio>

  <script type="module">
    // Firebase v9+ Modular Imports
    // *** UPDATED Firebase SDK version to 10.12.2 to fix internal errors ***
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, onSnapshot, deleteDoc, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
 
    document.addEventListener('DOMContentLoaded', async () => {

        // ------------------------------
        // Configuration
        // ------------------------------
        
        // --- !!! USER-REQUESTED FIREBASE CONFIG UPDATE !!! ---
        const firebaseConfig = {
          apiKey: "AIzaSyCuo69DgYtxCdVRmRvziVfnS69koYMGJ0E",
          authDomain: "dashboard-1fb59.firebaseapp.com",
          projectId: "dashboard-1fb59",
          storageBucket: "dashboard-1fb59.firebasestorage.app",
          messagingSenderId: "576174466807",
          appId: "1:576174466807:web:3d54f217da65b8480815f2",
          measurementId: "G-GHFVYG8C2Y"
        };
        // --- !!! END FIREBASE CONFIG UPDATE ---


        // NEW: Global state variables
        let db; // Firestore instance
        let dashboardConfig = null; // Will hold settings from Firestore
        let slideSources = []; // Will hold slides from Firestore
        const shownAlerts = new Set();
        
        // NEW: Interval timers
        let ipawsInterval = null;
        let weatherInterval = null;
        let slidesRefreshInterval = null;
        let slideRotationTimer = null;
        let tickerInterval = null; // Timer to check ticker dates

        // Slide rotation state
        const slideDivs = document.querySelectorAll('.slide');
        let contentIndex = 0;
        let activeSlideIndex = 0;
        // This is the special Google Slides object. It will be merged with data from Firestore.
        const googleSlideSource = { 
            type: 'googleslides', 
            iframe: ``, 
            duration: 20000,
            order: 1 // NEW: Give a default order
        };
        
        // *** NEW: Special News Feed slide object ***
        // This is now an HTML string, not an iframe src
        const newsFeedSlideSource = {
            type: 'newsfeed',
            iframe: `<div id="feed-container" class="relative w-full h-full overflow-hidden bg-gradient-to-br from-gray-900 to-gray-800 text-white font-sans">
                        <div id="feed-track" class="absolute top-0 left-0 w-full h-full">
                            <!-- Feed items will be injected here -->
                        </div>
                     </div>`,
            duration: 60000, // Default 60s, will be updated by fetchNewsFeed
            order: 2 // NEW: Give a default order (runs after Google Slides)
        };

        // *** NEW: News Feed Globals ***
        let newsFeedPosts = []; // Will hold fetched posts
        let newsFeedSlideInterval = null; // Controls the *internal* news slideshow
        // URL for your Google Sheet, published as a CSV
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRFwKf1UaKCKLASXnjnKprBD_dUoNxfj2ypNjC5x_vAzO6AmNJagIe86-uTkvGs_2xsXUthRDydbayG/pub?gid=248750333&single=true&output=csv';
        // How often to check for new data (in milliseconds)
        const REFRESH_INTERVAL_MS = 600000; // 10 minutes


        // ------------------------------
        // Ticker Logic (NEW)
        // ------------------------------
        function initializeTicker() {
            const tickerRef = collection(db, 'ticker');
            
            onSnapshot(tickerRef, (snapshot) => {
                const allMessages = [];
                snapshot.forEach(doc => {
                    allMessages.push(doc.data());
                });
                
                // Function to check dates and update UI
                const checkTicker = () => {
                    if (typeof dayjs === 'undefined') return;
                    const now = dayjs();
                    
                    // Filter valid messages
                    const activeMessages = allMessages.filter(msg => {
                        const start = dayjs(msg.startDateTime);
                        const end = dayjs(msg.endDateTime);
                        return start.isValid() && end.isValid() && now.isAfter(start) && now.isBefore(end);
                    }).map(msg => msg.message);

                    const tickerBar = document.getElementById('ticker-bar');
                    const tickerContent = document.getElementById('ticker-content');
                    
                    if (activeMessages.length > 0) {
                        // Join messages with a spacer
                        const fullText = activeMessages.join('   +++   ');
                        tickerContent.textContent = fullText;
                        
                        // Add animation class only if not present
                        if (!tickerContent.classList.contains('animate-marquee')) {
                             tickerContent.classList.add('animate-marquee');
                        }

                        // *** UPDATED DURATION CALCULATION ***
                        // Calculate duration for consistent speed (distance / speed)
                        // Speed target: ~150 pixels per second
                        // Total distance = Viewport Width (entry) + Text Width (exit)
                        // We estimate text width at roughly 25px per char for the large font
                        const estimatedTextWidth = fullText.length * 25; 
                        const totalDistance = window.innerWidth + estimatedTextWidth;
                        const speedPixelsPerSecond = 150; 
                        const duration = totalDistance / speedPixelsPerSecond;

                        tickerContent.style.animationDuration = `${duration}s`;

                        // Show bar
                        tickerBar.classList.remove('hidden');
                        tickerBar.classList.add('flex');
                    } else {
                        // Hide bar
                        tickerBar.classList.add('hidden');
                        tickerBar.classList.remove('flex');
                        tickerContent.classList.remove('animate-marquee');
                    }
                };

                // Check immediately
                checkTicker();

                // Clear old interval
                if (tickerInterval) clearInterval(tickerInterval);
                // Check every minute to start/stop messages based on time
                tickerInterval = setInterval(checkTicker, 60000); 
            });
        }

        // ------------------------------
        // Audio Context and Sound Playback
        // ------------------------------
        let audioEnabled = false;
        const alertAudioElement = document.getElementById('alertSound');
        const toneFileMap = {
            'default': 'sounds/default.mp3', 'alarm': 'sounds/alarm.mp3',
            'chime': 'sounds/chime.mp3', 'ascending': 'sounds/ascending.mp3'
        };

        function playAlertSound(toneName = 'default') {
            if (!audioEnabled) {
              console.warn("Audio not enabled by user yet. Click anywhere to enable.");
              return;
            }
            const fileName = toneFileMap[toneName] || `sounds/${toneName}`; // Allow custom files from config
            alertAudioElement.src = fileName;
            alertAudioElement.play().catch(error => {
              console.error(`Error playing sound "${fileName}":`, error);
              const overlay = document.getElementById("ipawsAlertOverlay");
              const errorSpan = document.createElement('span');
              errorSpan.textContent = ` [Audio file not found: ${fileName}]`;
              errorSpan.className = 'text-yellow-500 text-xl block mt-4';
              if (!overlay.querySelector('span')) overlay.appendChild(errorSpan);
            });
        }

        function enableAudio() {
          if (audioEnabled) return;
          audioEnabled = true;
          alertAudioElement.src = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=";
          alertAudioElement.play().catch(()=>{});
          alertAudioElement.pause();
          alertAudioElement.currentTime = 0;
          console.log('Audio context started by user interaction.');
          window.removeEventListener('click', enableAudio);
          window.removeEventListener('keydown', enableAudio);
        }
        window.addEventListener('click', enableAudio);
        window.addEventListener('keydown', enableAudio);

        // ------------------------------
        // *** NEW: News Feed Logic ***
        // ------------------------------

        /**
         * Fetches, parses, and filters news feed data from Google Sheets.
         * This function updates the global `newsFeedPosts` array and
         * calculates the total duration for the `newsFeedSlideSource`.
         */
        async function fetchNewsFeed() {
            if (!dashboardConfig) {
                console.warn("[NewsFeed] Config not loaded, skipping fetch.");
                return;
            }
            if (typeof Papa === 'undefined') {
                console.error("[NewsFeed] PapaParse is not loaded. Cannot fetch feed.");
                return;
            }
            console.log('[NewsFeed] Fetching new data...');
            
            Papa.parse(SHEET_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    try {
                        const activePosts = filterActivePosts(results.data);
                        newsFeedPosts = activePosts; // Store posts globally
                        
                        const secondsPerItem = dashboardConfig.newsFeed_secondsPerItem || 20;
                        // Calculate total duration
                        const totalDurationMs = activePosts.length * secondsPerItem * 1000;
                        
                        // Set the duration on the slide source object
                        // If 0 posts, set a fallback duration so it doesn't break the rotator
                        newsFeedSlideSource.duration = totalDurationMs > 0 ? totalDurationMs : 60000; 

                        console.log(`[NewsFeed] ${activePosts.length} posts loaded. Total duration set to ${newsFeedSlideSource.duration}ms`);
                        
                    } catch (error) {
                        console.error('[NewsFeed] Error processing data:', error);
                        newsFeedPosts = []; // Clear posts on error
                        newsFeedSlideSource.duration = 60000; // Fallback
                    }
                },
                error: (err) => {
                    console.error('[NewsFeed] Error fetching CSV:', err);
                    newsFeedPosts = []; // Clear posts on error
                    newsFeedSlideSource.duration = 60000; // Fallback
                }
            });
        }
        
        /**
         * Filters the list of posts to only include those that are
         * currently active based on their post and remove dates.
         */
        function filterActivePosts(posts) {
            if (typeof dayjs === 'undefined') {
                console.error("[NewsFeed] Day.js is not loaded. Cannot filter posts.");
                return [];
            }
            const now = dayjs();
            
            return posts.filter((post, index) => {
                const title = post['Title *'];
                const postDateStr = post['Date/Time to Post'];
                const removeDateStr = post['Date to Remove'];

                if (!title) return false;
                if (!postDateStr) return false;

                const postDate = dayjs(postDateStr);
                if (!postDate.isValid()) return false;
                
                if (!now.isAfter(postDate)) return false;
                
                if (removeDateStr) {
                    const removeDate = dayjs(removeDateStr);
                    if (removeDate.isValid() && now.isAfter(removeDate)) return false;
                }
                return true;
            });
        }

        /**
         * Renders the feed items into the provided container element.
         */
        function renderFeed(posts, feedContainer) {
            if (newsFeedSlideInterval) clearInterval(newsFeedSlideInterval);
            
            if (!feedContainer) {
                console.error("[NewsFeed] renderFeed called without a container.");
                return;
            }
            const feedTrack = feedContainer.querySelector('#feed-track');
            if (!feedTrack) {
                 console.error("[NewsFeed] renderFeed container is missing #feed-track.");
                 return;
            }
            feedTrack.innerHTML = ''; // Clear previous content

            if (posts.length === 0) {
                // Updated "No Active Announcements" screen
                feedContainer.innerHTML = `
                    <div class="w-full h-full flex flex-col justify-center items-center text-center p-10">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 text-gray-600 mb-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                        <h1 class="text-6xl text-gray-500 font-light">No Active Announcements</h1>
                        <p class="text-2xl text-gray-600 mt-4">The feed is currently empty. Please check back later.</p>
                    </div>
                `;
                return;
            }

            let itemsHtml = '';
            posts.forEach(post => {
                // New slide markup
                itemsHtml += `
                    <div class="feed-item w-full h-full absolute top-0 left-0 flex flex-col justify-center items-start p-24 sm:p-32 md:p-48">
                        <!-- Decorative element -->
                        <div class="w-24 h-2 bg-cyan-400 mb-8 rounded-full"></div>
                        
                        <!-- Title -->
                        <h1 class="text-7xl lg:text-8xl font-bold mb-6 text-white" style="text-shadow: 1px 1px 4px rgba(0,0,0,0.2);">
                            ${post['Title *']}
                        </h1>
                        
                        <!-- Description -->
                        <p class="text-3xl lg:text-4xl mb-12 text-gray-200 max-w-6xl font-light">
                            ${post['Description']}
                        </p>
                        
                        <!-- Meta Info with Icons -->
                        <div class="mt-8 pt-8 border-t border-gray-700 flex flex-wrap gap-x-10 gap-y-6 text-2xl text-gray-400">
                            ${post['Location'] ? `<span class="flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                <span>${post['Location']}</span>
                            </span>` : ''}
                            ${post['Applies To'] ? `<span class="flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 016-6h6m6 3v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                                <span>${post['Applies To']}</span>
                            </span>` : ''}
                            ${post['Posted by'] ? `<span class="flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                <span>${post['Posted by']}</span>
                            </span>` : ''}
                        </div>
                    </div>
                `;
            });

            feedTrack.innerHTML = itemsHtml;
            startSlideshow(posts.length, feedTrack); // Pass feedTrack
        }

        /**
         * Displays an error message in the provided container.
         */
        function displayError(message, feedContainer) {
            if (!feedContainer) {
                 console.error("[NewsFeed] displayError called without a container:", message);
                 return;
            }
            feedContainer.innerHTML = `
                <div class="w-full h-full flex flex-col justify-center items-center text-center p-10 bg-red-900">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 text-red-300 mb-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <h1 class="text-6xl font-bold mb-4 text-white">Feed Error</h1>
                    <p class="text-3xl text-red-200">${message}</p>
                </div>
            `;
        }

        /**
         * Manages the internal slideshow for the news feed, fading between items.
         */
        function startSlideshow(postCount, feedTrack) {
            if (!feedTrack) {
                console.error("[NewsFeed] startSlideshow called without feedTrack.");
                return;
            }
            const slides = feedTrack.querySelectorAll('.feed-item');
            if (slides.length === 0) return;

            // Clear any existing interval from a previous run
            if (newsFeedSlideInterval) clearInterval(newsFeedSlideInterval); 

            let currentSlideIndex = 0;
            // Show the first slide
            slides[currentSlideIndex].classList.add('active'); 
            // Remove 'fading-out' class in case it was stuck
            slides[currentSlideIndex].classList.remove('fading-out'); 

            if (postCount <= 1) return; // Don't do anything else if there's only one slide

            let slideIndex = 0; // Use a local index for the loop
            // Get duration from the *main* config object
            const secondsPerItem = (dashboardConfig && dashboardConfig.newsFeed_secondsPerItem) ? dashboardConfig.newsFeed_secondsPerItem : 20;

            newsFeedSlideInterval = setInterval(() => {
                if (slideIndex < postCount - 1) {
                    // We are not on the last slide, so transition to the next
                    
                    // Add fading-out class to trigger exit animation
                    slides[slideIndex].classList.add('fading-out'); 
                    // Remove active class
                    slides[slideIndex].classList.remove('active'); 
                    
                    slideIndex++;

                    // Add active class to trigger new slide's entrance animation
                    slides[slideIndex].classList.add('active'); 
                    // Remove fading-out class from new slide just in case
                    slides[slideIndex].classList.remove('fading-out'); 
                } else {
                    // This was the last slide, clear the interval and stop
                    clearInterval(newsFeedSlideInterval);
                    newsFeedSlideInterval = null;
                    console.log('[NewsFeed] End of slideshow, stopping on last post.');
                }
            }, secondsPerItem * 1000);
        }

        // ------------------------------
        // Slide Rotation Logic
        // ------------------------------
        
        async function setupGoogleSlides() {
            // NEW: Guard against config not being loaded
            if (!dashboardConfig) {
                console.warn("Google Slides setup skipped, config not yet loaded.");
                return;
            }

            const slidesConfig = dashboardConfig; // Config is now the flat object from Firestore
            const slidesSource = slideSources.find(s => s.type === 'googleslides');

            if (!slidesConfig.googleSlides_scriptUrl || slidesConfig.googleSlides_scriptUrl.includes('PASTE') || !slidesSource) {
                console.error("Google Slides Apps Script URL is not configured in admin console or slidesSource is missing.");
                if(slidesSource) {
                    slidesSource.iframe = `<div class="w-full h-full flex items-center justify-center bg-gray-800 text-yellow-300 p-8 text-center text-2xl"><strong>Configuration Needed:</strong><br>Please set your Google Slides Apps Script URL in the <strong>Admin Console</strong>.</div>`;
                    slidesSource.duration = 20000;
                }
                return;
            }

            try {
                const response = await fetch(slidesConfig.googleSlides_scriptUrl, { cache: 'no-cache' });
                if (!response.ok) throw new Error(`Failed to fetch slide count. Status: ${response.status}.`);
                
                const slideCount = parseInt(await response.text(), 10);
                if (isNaN(slideCount) || slideCount <= 0) throw new Error(`Invalid slide count received: ${slideCount}`);

                const delayMs = slidesConfig.googleSlides_delayPerSlideSeconds * 1000;
                const totalDuration = slideCount * delayMs;
                // *** NEW: Check for 0 delayMs, which causes Google Slides to use its default
                if (delayMs <= 0) {
                    console.warn("Google Slides delay is 0, duration cannot be calculated. Using default 20s.");
                    slidesSource.duration = 20000; // Fallback
                } else {
                    slidesSource.duration = totalDuration;
                }
                
                const embedUrl = `${slidesConfig.googleSlides_embedUrlBase}&delayms=${delayMs}`;
                const iframeHtml = `<iframe title="Google Slides" src="${embedUrl}" frameborder="0" class="w-full h-full"></iframe>`;

                slidesSource.iframe = iframeHtml;
                console.log(`Google Slides configured with ${slideCount} slides for a total duration of ${slidesSource.duration / 1000}s.`);

            } catch (error) {
                console.error("Error setting up Google Slides:", error);
                if(slidesSource){
                    slidesSource.iframe = `<div class="w-full h-full flex items-center justify-center bg-gray-800 text-red-400 p-8 text-center text-2xl"><strong>Error:</strong><br>Could not load Google Slides count.<br>${error.message}</div>`;
                    slidesSource.duration = 20000;
                }
            }
        }

        function scheduleNextSlide(duration) { 
            if (slideRotationTimer) clearTimeout(slideRotationTimer);
            slideRotationTimer = setTimeout(() => { 
                contentIndex = (contentIndex + 1) % slideSources.length; 
                rotateSlides(); 
            }, duration); 
        }

        function rotateSlides() {
            if (slideSources.length === 0) {
                console.warn("No slide sources available. Halting rotation.");
                return;
            }
            if (contentIndex >= slideSources.length) contentIndex = 0;

            let source = slideSources[contentIndex];
            const initialIndex = contentIndex;
            
            while (source.duration === 0) {
                console.log(`Skipping slide "${source.type || source.iframe.substring(0, 50)}" (duration is 0).`);
                contentIndex = (contentIndex + 1) % slideSources.length;
                source = slideSources[contentIndex];
                if (contentIndex === initialIndex) { 
                    console.warn("All slides have a duration of 0 or are unavailable. Halting rotation."); 
                    return; 
                }
            }

            const nextSlideIndex = 1 - activeSlideIndex;
            const currentSlide = slideDivs[activeSlideIndex];
            const nextSlide = slideDivs[nextSlideIndex];
            
            nextSlide.innerHTML = source.iframe;

            // *** NEW: Check if this is the news feed slide and render its content ***
            if (source.type === 'newsfeed') {
                if (newsFeedSlideInterval) clearInterval(newsFeedSlideInterval); // Stop any previous interval
                const feedContainer = nextSlide.querySelector('#feed-container');
                if (feedContainer) {
                    renderFeed(newsFeedPosts, feedContainer); // Render posts and start internal slideshow
                } else {
                    console.error("[NewsFeed] Slide container #feed-container not found after injection.");
                    nextSlide.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-red-800 text-white p-4">News Feed Error: Could not find #feed-container.</div>`;
                }
            } else {
                // *** NEW: If this is NOT the news feed, clear its interval ***
                if (newsFeedSlideInterval) {
                    clearInterval(newsFeedSlideInterval);
                    newsFeedSlideInterval = null;
                }
            }
            // *** END: News feed logic ***

            const iframe = nextSlide.querySelector('iframe');
            
            const transition = () => {
                if (nextSlide.classList.contains('opacity-100')) return;
                currentSlide.classList.remove('opacity-100');
                currentSlide.classList.add('opacity-0');
                nextSlide.classList.remove('opacity-0');
                nextSlide.classList.add('opacity-100');
                activeSlideIndex = nextSlideIndex;
                scheduleNextSlide(source.duration);
            };

            if (iframe) {
                let loaded = false;
                const loadTimeout = setTimeout(() => {
                    if (!loaded) {
                        console.warn("Iframe load timed out, transitioning anyway:", source.iframe);
                        transition();
                    }
                }, 5000); 

                iframe.onload = () => { loaded = true; clearTimeout(loadTimeout); transition(); };
                iframe.onerror = () => {
                    loaded = true; clearTimeout(loadTimeout);
                    console.error("Iframe failed to load:", source.iframe);
                    nextSlide.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-800 text-red-400 p-8 text-center text-2xl"><strong>Error:</strong><br>Could not load slide content.</div>`;
                    transition();
                };
            } else {
                // This 'else' block now handles non-iframe slides, like the news feed
                transition();
            }
        }

        async function startRotation() {
            if (slideRotationTimer) clearTimeout(slideRotationTimer);
            
            // Setup Google Slides (depends on dashboardConfig)
            await setupGoogleSlides(); 
            
            if (slideSources.length === 0) {
                console.warn("No slides to display.");
                slideDivs[0].innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-800 text-yellow-300 p-8 text-center text-2xl">No slides configured. Please add slides in the admin console.</div>`;
                slideDivs[0].classList.remove('opacity-0');
                slideDivs[0].classList.add('opacity-100');
                return;
            }

            contentIndex = 0;
            // *** UPDATED: Find first slide with duration > 0 ***
            let firstSource = slideSources[contentIndex];
            const initialIndex = contentIndex;
            while (firstSource.duration === 0) {
                contentIndex = (contentIndex + 1) % slideSources.length;
                firstSource = slideSources[contentIndex];
                if (contentIndex === initialIndex) { 
                    console.warn("All slides have a duration of 0 or are unavailable. Halting rotation."); 
                    slideDivs[0].innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-800 text-yellow-300 p-8 text-center text-2xl">All slides are currently disabled (duration 0).</div>`;
                    slideDivs[0].classList.add('opacity-100');
                    return; 
                }
            }
            
            slideDivs[0].innerHTML = firstSource.iframe;
            // *** NEW: Render news feed if it's the first slide ***
            if (firstSource.type === 'newsfeed') {
                if (newsFeedSlideInterval) clearInterval(newsFeedSlideInterval);
                const feedContainer = slideDivs[0].querySelector('#feed-container');
                if (feedContainer) {
                    renderFeed(newsFeedPosts, feedContainer);
                }
            }
            // *** END: News feed logic ***

            slideDivs[1].innerHTML = '';
            slideDivs[1].classList.remove('opacity-100');
            slideDivs[1].classList.add('opacity-0');
            
            const transition = () => {
                if (slideDivs[0].classList.contains('opacity-100')) return;
                slideDivs[0].classList.remove('opacity-0');
                slideDivs[0].classList.add('opacity-100');
                activeSlideIndex = 0;
                scheduleNextSlide(firstSource.duration);
            };
            
            const firstIframe = slideDivs[0].querySelector('iframe');
            if(firstIframe) {
                let loaded = false;
                const loadTimeout = setTimeout(() => {
                    if (!loaded) {
                        console.warn("First iframe load timed out, transitioning anyway.");
                        transition();
                    }
                }, 5000);
                firstIframe.onload = () => { loaded = true; clearTimeout(loadTimeout); transition(); };
                firstIframe.onerror = () => { loaded = true; clearTimeout(loadTimeout); console.error("First iframe failed to load:", firstSource.iframe); transition(); };
            } else {
                // This handles non-iframe slides like the news feed
                transition();
            }
        }

        // ------------------------------
        // Remote & NWS Alert System
        // ------------------------------
        
        function showIPAWSAlert(message, duration, toneName = 'default') {
          const overlay = document.getElementById("ipawsAlertOverlay");
          overlay.innerHTML = message;
          overlay.classList.remove('invisible', 'opacity-0');
          overlay.classList.add('opacity-100');
          playAlertSound(toneName);
          setTimeout(() => {
            overlay.classList.remove('opacity-100');
            overlay.classList.add('invisible', 'opacity-0');
          }, duration);
        }

        async function fetchIPAWSAlerts() {
          // NEW: Guard against config not being loaded
          if (!dashboardConfig || !dashboardConfig.nwsAlertZone) {
              console.warn("IPAWS fetch skipped, config not loaded or NWS zone not set.");
              return;
          }
          try {
            // *** FIXED: Added headers required by NWS API to prevent 403 Forbidden errors ***
            const response = await fetch(`https://api.weather.gov/alerts/active/zone/${dashboardConfig.nwsAlertZone}`, {
                headers: {
                    'Accept': 'application/geo+json',
                    'User-Agent': '(PTFD Dashboard)' // NWS requires a User-Agent
                }
            });

            if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
            const data = await response.json();
            
            // ---------------------------------------------------------
            // *** NEW: Sidebar Persistent Alert Logic ***
            // ---------------------------------------------------------
            const sidebarAlert = document.getElementById('sidebar-alert-display');
            if (sidebarAlert) {
                if (data.features && data.features.length > 0) {
                    // 1. Extract unique event names
                    const events = [...new Set(data.features.map(f => f.properties.event))];
                    // 2. Format them for display
                    const alertHtml = events.join('<br>');
                    
                    // 3. Update the Sidebar HTML
                    sidebarAlert.innerHTML = `
                        <div class="bg-red-600 text-white rounded-lg p-3 animate-pulse border-2 border-red-400 shadow-lg text-center">
                            <div class="flex justify-center mb-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                            </div>
                            <p class="text-sm font-black uppercase tracking-wide leading-tight">${alertHtml}</p>
                        </div>
                    `;
                    sidebarAlert.classList.remove('hidden');
                } else {
                    sidebarAlert.classList.add('hidden');
                    sidebarAlert.innerHTML = '';
                }
            }
            // ---------------------------------------------------------

            const newAlertMessages = [];
            if (data.features && data.features.length > 0) {
              for (const feature of data.features) {
                const alertId = feature.id;
                if (!shownAlerts.has(alertId)) {
                  newAlertMessages.push(feature.properties.headline);
                  shownAlerts.add(alertId);
                }
              }
            }
            if (newAlertMessages.length > 0) {
              const fullMessage = newAlertMessages.join(' <span class="text-gray-500 mx-4">|||</span> ');
              const displayDuration = 60000 * newAlertMessages.length;
              showIPAWSAlert(fullMessage, displayDuration, 'alarm');
            }
          } catch (err) {
            console.error("IPAWS/NWS alert fetch failed:", err);
          }
        }
        
        // ------------------------------
        // Toolbar Weather Widget
        // ------------------------------

        function getWeatherIcon(weatherCode) {
            const WMO_ICONS = {
                0: 'sun', 1: 'sun', 2: 'cloud', 3: 'cloud-drizzle', 45: 'cloud-fog', 48: 'cloud-fog',
                51: 'cloud-drizzle', 53: 'cloud-drizzle', 55: 'cloud-drizzle', 56: 'cloud-drizzle', 57: 'cloud-drizzle',
                61: 'cloud-rain', 63: 'cloud-rain', 65: 'cloud-rain', 66: 'cloud-rain', 67: 'cloud-rain',
                71: 'cloud-snow', 73: 'cloud-snow', 75: 'cloud-snow', 77: 'cloud-snow',
                80: 'cloud-rain', 81: 'cloud-rain', 82: 'cloud-rain', 85: 'cloud-snow', 86: 'cloud-snow',
                95: 'cloud-lightning', 96: 'cloud-lightning', 99: 'cloud-lightning'
            };
            return WMO_ICONS[weatherCode] || 'help-circle';
        }

        function getWeatherCondition(weatherCode) {
            const CONDITIONS = { 
                0: "Clear", 1: "Clear", 2: "Cloudy", 3: "Overcast", 45: "Fog", 48: "Fog", 
                51: "Drizzle", 53: "Drizzle", 55: "Drizzle", 56: "Freezing Drizzle", 57: "Freezing Drizzle", 
                61: "Rain", 63: "Rain", 65: "Rain", 66: "Freezing Rain", 67: "Freezing Rain", 
                71: "Snow", 73: "Snow", 75: "Snow", 77: "Snow", 80: "Showers", 81: "Showers", 82: "Showers", 
                85: "Snow Showers", 86: "Snow Showers", 95: "Thunderstorm", 96: "Thunderstorm", 99: "Thunderstorm" 
            };
            return CONDITIONS[weatherCode] || 'N/A';
        }

        async function fetchToolbarWeather() {
            // NEW: Guard against config not being loaded
            if (!dashboardConfig || !dashboardConfig.weather_latitude) {
                console.warn("Weather fetch skipped, config not loaded or latitude not set.");
                return;
            }

            const weather = dashboardConfig; // Use the loaded config
            // *** FIX: Removed extra 'https' from URL ***
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${weather.weather_latitude}&longitude=${weather.weather_longitude}&current=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&timezone=auto`;
            
            const tempEl = document.getElementById('weather-temp');
            const conditionEl = document.getElementById('weather-condition');
            const highLowEl = document.getElementById('weather-high-low');
            const locationEl = document.getElementById('weather-location');
            const iconContainer = document.getElementById('weather-icon-container');

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error("Failed to fetch weather");
                const data = await response.json();
                
                const temp = Math.round(data.current.temperature_2m);
                const high = Math.round(data.daily.temperature_2m_max[0]);
                const low = Math.round(data.daily.temperature_2m_min[0]);
                const weatherCode = data.current.weather_code;
                
                const condition = getWeatherCondition(weatherCode);
                const iconName = getWeatherIcon(weatherCode);

                tempEl.textContent = `${temp}°`;
                conditionEl.textContent = condition;
                locationEl.textContent = weather.weather_locationName;
                highLowEl.textContent = `H: ${high}° L: ${low}°`;
                iconContainer.innerHTML = `<i data-feather="${iconName}" class="w-16 h-16"></i>`;
                feather.replace();

            } catch (error) {
                console.error("Toolbar weather fetch failed:", error);
                conditionEl.textContent = 'Weather unavailable';
                tempEl.textContent = '--°';
                highLowEl.textContent = 'H: --° L: --°';
                iconContainer.innerHTML = `<i data-fether="alert-triangle" class="w-16 h-16 text-yellow-400"></i>`;
                feather.replace();
            }
        }

        // ------------------------------
        // Firebase Listeners (NEW STRUCTURE)
        // ------------------------------
        
        // --- This listener starts all other listeners once config is loaded ---
        function initializeConfigListener() {
            const configDocRef = doc(db, 'config', 'global');
            
            let firstConfigLoad = true; 

            // *** UPDATED: Made the onSnapshot callback async ***
            onSnapshot(configDocRef, async (docSnap) => {
                if (docSnap.exists()) {
                    console.log("Global config loaded/updated.");
                    dashboardConfig = docSnap.data();

                    // --- UPDATED: Load Logo URL ---
                    const logoImg = document.getElementById('dashboard-logo');
                    if (dashboardConfig.logoUrl) {
                        logoImg.src = dashboardConfig.logoUrl;
                        logoImg.style.display = 'block'; // Ensure it's visible
                    } else {
                        // If no logo is set in config, hide the element
                        logoImg.style.display = 'none';
                    }
                    // --- End of Logo Update ---

                    // Clear old intervals before setting new ones
                    if (ipawsInterval) clearInterval(ipawsInterval);
                    if (weatherInterval) clearInterval(weatherInterval);
                    if (slidesRefreshInterval) clearInterval(slidesRefreshInterval);

                    // Trigger initial fetches with new config
                    fetchIPAWSAlerts();
                    fetchToolbarWeather();
                    
                    // --- *** BEGIN FIX *** ---
                    if (firstConfigLoad) {
                        console.log("Attaching persistent listeners for alerts and slides.");
                        initializeAlertListener(); 
                        initializeSlideListener(); // This will call startRotation() on its own
                        initializeForceReloadListener(); // *** NEW ***
                        
                        // *** NEW: Start Ticker ***
                        initializeTicker(); 

                        // *** NEW: Start news feed fetching ***
                        fetchNewsFeed(); // Initial fetch
                        setInterval(fetchNewsFeed, REFRESH_INTERVAL_MS); // Set refresh interval
                        // *** END: News feed fetching ***

                        firstConfigLoad = false;
                    } else {
                        // On subsequent loads (manual refresh), just re-fetch Google Slides data
                        // AND news feed data
                        console.log("Config reloaded. Re-fetching Google Slides and News Feed data.");
                        await setupGoogleSlides();
                        fetchNewsFeed(); // Re-fetch news to update duration
                    }
                    // --- *** END FIX *** ---

                    // Set new intervals based on loaded config
                    const ipawsRefreshMs = (dashboardConfig.nwsAlertRefreshSeconds || 300) * 1000;
                    ipawsInterval = setInterval(fetchIPAWSAlerts, ipawsRefreshMs);
                    
                    const weatherRefreshMs = Math.max(dashboardConfig.weather_refreshIntervalMinutes || 10, 1) * 60 * 1000;
                    weatherInterval = setInterval(fetchToolbarWeather, weatherRefreshMs);

                    if (dashboardConfig.googleSlides_refreshIntervalMinutes > 0) {
                        const slidesRefreshMs = dashboardConfig.googleSlides_refreshIntervalMinutes * 60 * 1000;
                        slidesRefreshInterval = setInterval(async () => {
                            console.log("Checking for Google Slides updates...");
                            await setupGoogleSlides();
                        }, slidesRefreshMs);
                    }
                } else {
                    console.error("FATAL: Global config document ('config/global') not found. Dashboard cannot function.");
                    slideDivs[0].innerHTML = `<div class="w-full h-full flex items-center justify-center bg-red-900 text-white p-8 text-center text-3xl"><strong>FATAL ERROR:</strong><br>Global configuration not found in database. Please set it in the admin console.</div>`;
                    slideDivs[0].classList.add('opacity-100');
                    // Also hide the logo if config fails
                    document.getElementById('dashboard-logo').style.display = 'none';
                }
            }, (error) => { // *** NEW: RELIABILITY FIX ***
                // This is the error callback for the *config* listener itself.
                console.error("FATAL: Firestore config listener failed:", error);
                slideDivs[0].innerHTML = `<div class="w-full h-full flex items-center justify-center bg-red-900 text-white p-8 text-center text-3xl"><strong>FATAL ERROR:</strong><br>Connection to configuration lost. Please refresh.<br>${error.message}</div>`;
                slideDivs[0].classList.add('opacity-100');
                document.getElementById('dashboard-logo').style.display = 'none';
                
                // Stop all intervals since config is gone
                if (ipawsInterval) clearInterval(ipawsInterval);
                if (weatherInterval) clearInterval(weatherInterval);
                if (slidesRefreshInterval) clearInterval(slidesRefreshInterval);
            });
        }

        // --- Listens for manual alerts ---
        function initializeAlertListener() {
            const alertDocRef = doc(db, 'alerts', 'manual_alert');
            let isDeletingManualAlert = false; // Latch flag

            onSnapshot(alertDocRef, (docSnap) => {
                if (docSnap.exists() && !isDeletingManualAlert) { // Check flag
                    isDeletingManualAlert = true; // Set flag
                    console.log("Remote alert received:", docSnap.data());
                    const alertData = docSnap.data();
                    if (alertData && alertData.message && alertData.duration) {
                        let displayMessage = alertData.title ? 
                            `<div class="text-center"><h1 class="text-6xl md:text-7xl font-black mb-4">${alertData.title}</h1><p class="text-4xl md:text-5xl font-bold">${alertData.message}</p></div>` : 
                            alertData.message;
                        showIPAWSAlert(displayMessage, alertData.duration, alertData.tone || 'default');
                        
                        // Delete doc and reset flag on completion *or* error
                        deleteDoc(alertDocRef).catch((err) => {
                            console.error("Error deleting manual alert doc:", err);
                            // *** RELIABILITY FIX ***
                            // Reset the latch even if delete fails (e.g., permissions)
                            // This allows the *next* alert to be processed.
                            isDeletingManualAlert = false; 
                        });
                    } else {
                        // *** ADDED: Handle invalid alert data ***
                        isDeletingManualAlert = false;
                    }
                } else if (!docSnap.exists()) {
                    isDeletingManualAlert = false; // Reset flag when doc is gone
                }
            }, (error) => {
                console.error("Error with Firestore alert listener: ", error);
                isDeletingManualAlert = false; // Reset on error
            });
        }

        // --- NEW: Listens for a force reload signal ---
        function initializeForceReloadListener() {
            const forceReloadDocRef = doc(db, 'alerts', 'force_reload');

            onSnapshot(forceReloadDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    console.warn("FORCE RELOAD signal received. Deleting signal and reloading page from server...");
                    
                    // Delete the doc first to prevent reload loops
                    deleteDoc(forceReloadDocRef).then(() => {
                        // Reload from server, bypassing cache
                        window.location.reload(true);
                    }).catch((err) => {
                        console.error("Error deleting force_reload doc. Reloading anyway.", err);
                        // Force reload even if delete fails
                        window.location.reload(true);
                    });
                }
            }, (error) => { // *** NEW: RELIABILITY FIX ***
                 console.error("Error with Firestore force_reload listener:", error);
                 // This is non-critical, so we just log it and continue.
            });
        }

        // --- Listens for slide list changes ---
        function initializeSlideListener() {
            const slidesQuery = query(collection(db, 'slides'), orderBy('order'));
            onSnapshot(slidesQuery, (snapshot) => {
                console.log("Slide configuration updated from Firestore.");
                // *** UPDATED: Always start with special slides ***
                const newSlideSources = [googleSlideSource, newsFeedSlideSource]; 
                
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.iframe && data.duration > 0) {
                        newSlideSources.push(data);
                    } else {
                        console.warn("Skipping invalid slide from Firestore:", doc.id, data);
                    }
                });

                // *** NEW: Sort all slides by order ***
                newSlideSources.sort((a, b) => (a.order || 99) - (b.order || 99));

                slideSources = newSlideSources; // Update the global slideSources array
                startRotation(); // Restart the slide rotation with the new data
            }, (error) => {
                console.error("Error listening to slides collection: ", error);
                // *** UPDATED: Fallback to special slides ***
                slideSources = [googleSlideSource, newsFeedSlideSource].sort((a, b) => a.order - b.order);
                startRotation();
            });
        }
        
        // ------------------------------
        // Main Initialization
        // ------------------------------
        function initializeFirebase() {
            try {
                // *** UPDATED: Check the new firebaseConfig object ***
                if (!firebaseConfig || firebaseConfig.apiKey.startsWith("PASTE_")) {
                     console.warn("Firebase is not configured. Remote features are disabled.");
                     return;
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);

                // Start by fetching config. Everything else depends on it.
                // *** UPDATED: This will now handle attaching other listeners on first load ***
                initializeConfigListener();

            } catch(e) {
                console.error("Failed to initialize Firebase listener:", e);
            }
        }

        // Start the application
        initializeFirebase();
        feather.replace(); // Initial icon render
    });
  </script>

</body>
</html>